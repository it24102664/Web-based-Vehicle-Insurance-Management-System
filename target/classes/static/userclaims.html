<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Claim Management - MotorCare LK</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
    /* Header */
    .header { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1); }
    .logo { display: flex; align-items: center; gap: 10px; font-size: 1.5rem; font-weight: 700; color: #667eea; }
    .logo::before { content: "üõ°Ô∏è"; font-size: 1.8rem; }
    .nav-buttons { display: flex; gap: 1rem; }
    .nav-btn { padding: 0.5rem 1rem; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; }
    .dashboard-btn { background: #f0f2ff; color: #667eea; }
    .logout-btn { background: #ff6b6b; color: white; }
    .nav-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); }
    /* Main Container */
    .container { display: flex; min-height: calc(100vh - 80px); }
    /* Sidebar */
    .sidebar { width: 280px; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); padding: 2rem; }
    .user-panel { color: white; margin-bottom: 2rem; }
    .user-panel h2 { display: flex; align-items: center; gap: 10px; font-size: 1.3rem; margin-bottom: 0.5rem; }
    .user-panel h2::before { content: "üë§"; }
    .menu-item { display: flex; align-items: center; padding: 1rem; margin-bottom: 0.5rem; border-radius: 12px; color: white; text-decoration: none; transition: all 0.3s ease; cursor: pointer; }
    .menu-item:hover { background: rgba(255, 255, 255, 0.2); transform: translateX(5px); }
    .menu-item.active { background: rgba(255, 255, 255, 0.25); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
    .menu-item::before { margin-right: 10px; font-size: 1.2rem; }
    .overview::before { content: "üìä"; }
    .submit-claim::before { content: "üìù"; }
    .notifications::before { content: "üîî"; }
    .claim-forms::before { content: "üìã"; }
    /* Main Content */
    .main-content { flex: 1; padding: 2rem; background: rgba(255, 255, 255, 0.95); margin: 1rem; border-radius: 20px; backdrop-filter: blur(10px); }
    .page-header { display: flex; align-items: center; gap: 15px; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid #f0f2ff; }
    .page-header h1 { font-size: 2rem; color: #333; }
    .page-header::before { content: "üöó"; font-size: 2.5rem; }
    /* Stats Cards */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
    .stat-card { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 1.5rem; border-radius: 16px; text-align: center; box-shadow: 0 8px 25px rgba(102, 126, 234, 0.25); transition: transform 0.3s ease; }
    .stat-card:hover { transform: translateY(-5px); }
    .stat-number { font-size: 2.5rem; font-weight: 700; margin-bottom: 0.5rem; }
    .stat-label { font-size: 0.9rem; opacity: 0.9; }
    /* Claims Section */
    .claims-section { background: white; border-radius: 16px; padding: 1.5rem; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); }
    .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
    .section-title { font-size: 1.4rem; color: #333; font-weight: 600; }
    .filter-tabs { display: flex; gap: 0.5rem; }
    .filter-tab { padding: 0.5rem 1rem; border: 2px solid #667eea; background: transparent; color: #667eea; border-radius: 25px; cursor: pointer; transition: all 0.3s ease; font-weight: 500; }
    .filter-tab.active, .filter-tab:hover { background: #667eea; color: white; transform: translateY(-2px); }
    /* Claims List */
    .claims-list { max-height: 600px; overflow-y: auto; }
    .claim-item { border: 1px solid #e1e5f2; border-radius: 12px; margin-bottom: 1rem; overflow: hidden; transition: all 0.3s ease; }
    .claim-item:hover { box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1); transform: translateY(-2px); }
    .claim-header { padding: 1rem 1.5rem; background: #f8faff; display: flex; justify-content: space-between; align-items: center; cursor: pointer; position: relative; }
    .claim-info { flex: 1; }
    .claim-id { font-weight: 600; color: #667eea; font-size: 1.1rem; }
    .claim-meta { display: flex; gap: 2rem; margin-top: 0.5rem; font-size: 0.9rem; color: #666; }
    .claim-status { padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600; display: flex; align-items: center; }
    .status-pending { background: #fff3cd; color: #856404; }
    .status-approved { background: #d4edda; color: #155724; }
    .status-rejected { background: #f8d7da; color: #721c24; }
    .expand-icon { font-size: 1.2rem; color: #667eea; transition: transform 0.3s ease; }
    .claim-item.expanded .expand-icon { transform: rotate(180deg); }
    /* Claim Details */
    .claim-details { padding: 1.5rem; display: none; border-top: 1px solid #e1e5f2; }
    .claim-item.expanded .claim-details { display: block; animation: slideDown 0.3s ease; }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    .details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 1.5rem; }
    .detail-section h4 { color: #667eea; margin-bottom: 0.75rem; font-size: 1rem; font-weight: 600; }
    .detail-item { margin-bottom: 0.5rem; font-size: 0.9rem; }
    .detail-label { font-weight: 600; color: #555; display: inline-block; min-width: 120px; }
    .description-section { grid-column: span 2; }
    .description-text { background: #f8faff; padding: 1rem; border-radius: 8px; border-left: 4px solid #667eea; font-style: italic; color: #666; }
    .photos-section { margin: 1.5rem 0; }
    .photos-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; margin-top: 1rem; }
    .photo-thumbnail { width: 100%; height: 120px; object-fit: cover; border-radius: 8px; cursor: pointer; transition: transform 0.3s ease; }
    .photo-thumbnail:hover { transform: scale(1.05); }
    /* Status Messages */
    .status-message { font-weight: 600; display: flex; align-items: center; gap: 0.5rem; padding-top: 1rem; }
    .status-message.approved { color: #28a745; }
    .status-message.rejected { color: #dc3545; }
    /* Claim Form Section */
    .claim-form-section { background: white; border-radius: 16px; padding: 1.5rem; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); display: none; }
    .form-description { margin-bottom: 1.5rem; padding: 1rem; background: linear-gradient(135deg, #f0f2ff, #e8f0ff); border-radius: 12px; border-left: 4px solid #667eea; }
    .form-description h3 { color: #667eea; margin-bottom: 0.5rem; }
    .form-description p { font-style: italic; color: #666; line-height: 1.5; }
    .claim-form { display: grid; gap: 1rem; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .form-group { display: flex; flex-direction: column; }
    .form-group label { font-weight: 600; margin-bottom: 0.5rem; color: #555; }
    .form-group input, .form-group textarea, .form-group select { padding: 0.75rem; border: 1px solid #e1e5f2; border-radius: 8px; font-size: 1rem; transition: border-color 0.3s ease; }
    .form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
    .form-group textarea { min-height: 100px; resize: vertical; }
    .form-group input[type="file"] { border: none; padding: 0; }
    .submit-btn { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 1rem 2rem; border: none; border-radius: 25px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; margin-top: 1rem; }
    .submit-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2); }
    .submit-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    /* Claim Forms Section */
    .claim-forms-section { background: white; border-radius: 16px; padding: 1.5rem; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); display: none; }
    .forms-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-top: 1.5rem; }
    .form-card { border: 1px solid #e1e5f2; border-radius: 12px; padding: 1.5rem; transition: all 0.3s ease; }
    .form-card:hover { box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1); transform: translateY(-2px); }
    .form-card-header { display: flex; align-items: center; gap: 10px; margin-bottom: 1rem; }
    .form-card-icon { font-size: 2rem; }
    .form-card-title { font-size: 1.2rem; font-weight: 600; color: #667eea; }
    .form-card-instructions { color: #666; font-size: 0.9rem; margin-bottom: 1rem; line-height: 1.5; }
    .form-card-meta { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; font-size: 0.8rem; color: #999; }
    .use-form-btn { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 25px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; width: 100%; }
    .use-form-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); }
    /* Dynamic Form Fields */
    .dynamic-field { margin-bottom: 1rem; }
    .field-required { color: #dc3545; }
    /* Notifications Section */
    .notifications-section { background: white; border-radius: 16px; padding: 1.5rem; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); display: none; }
    .notification-item { border: 1px solid #e1e5f2; border-radius: 12px; padding: 1rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 1rem; }
    .notification-item.new { border-color: #667eea; background: #f0f2ff; }
    .notification-icon { font-size: 1.5rem; }
    .notification-content { flex: 1; }
    .notification-title { font-weight: 600; margin-bottom: 0.25rem; }
    .notification-text { color: #666; font-size: 0.9rem; }
    .notification-time { color: #999; font-size: 0.8rem; }
    /* Loading States */
    .loading { opacity: 0.6; pointer-events: none; position: relative; }
    .loading::after { content: "Loading..."; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); z-index: 10; }
    /* Modal */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 1000; justify-content: center; align-items: center; }
    .modal.active { display: flex; }
    .modal-content { background: white; padding: 2rem; border-radius: 16px; max-width: 500px; width: 90%; text-align: center; }
    .modal h3 { margin-bottom: 1rem; color: #333; }
    .modal p { margin-bottom: 1rem; }
    .modal-buttons { display: flex; gap: 1rem; justify-content: center; }
    .modal-btn { padding: 0.75rem 1.5rem; border: none; border-radius: 25px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; }
    .confirm-btn { background: #667eea; color: white; }
    .cancel-btn { background: #6c757d; color: white; }
    /* Notification */
    .notification { position: fixed; top: 20px; right: 20px; padding: 1rem 1.5rem; border-radius: 8px; color: white; font-weight: 600; z-index: 1001; transform: translateX(400px); transition: transform 0.3s ease; }
    .notification.show { transform: translateX(0); }
    .notification.success { background: #28a745; }
    .notification.error { background: #dc3545; }
    .notification.info { background: #17a2b8; }
    /* Responsive */
    @media (max-width: 768px) {
      .container { flex-direction: column; }
      .sidebar { width: 100%; padding: 1rem; }
      .details-grid { grid-template-columns: 1fr; }
      .description-section { grid-column: span 1; }
      .filter-tabs { flex-wrap: wrap; }
      .form-row { grid-template-columns: 1fr; }
      .forms-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
<!-- Header -->
<div class="header">
  <div class="logo">MOTORCARE LK</div>
  <div class="nav-buttons">



    <button class="nav-btn dashboard-btn" onclick="refreshDashboard()">üìä Refresh</button>
    <button class="nav-btn logout-btn" onclick="logout('index.html')">üö™ Logout</button>
  </div>
</div>
<div class="container">
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="user-panel">
      <h2>User Panel</h2>
      <p>Claim Management</p>
    </div>
    <div class="menu-item overview active" onclick="showSection('overview', this)">Overview</div>
    <div class="menu-item claim-forms" onclick="showSection('claim-forms', this)">Available Forms</div>
    <div class="menu-item submit-claim" onclick="showSection('submit-claim', this)">Quick Submit</div>
    <div class="menu-item notifications" onclick="showSection('notifications', this)">Notifications</div>
  </div>
  <!-- Main Content -->
  <div class="main-content">
    <!-- Overview Section -->
    <div id="overview-section">
      <div class="page-header">
        <h1>Claim Overview</h1>
      </div>
      <!-- Stats -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number" id="pendingCount">0</div>
          <div class="stat-label">Pending Claims</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="approvedCount">0</div>
          <div class="stat-label">Approved Claims</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="rejectedCount">0</div>
          <div class="stat-label">Rejected Claims</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="totalCount">0</div>
          <div class="stat-label">Total Claims</div>
        </div>
      </div>
      <!-- Claims Section -->
      <div class="claims-section">
        <div class="section-header">
          <h2 class="section-title">My Claims</h2>
          <div class="filter-tabs">
            <button class="filter-tab active" data-filter="all" onclick="filterClaims('all', this)">All</button>
            <button class="filter-tab" data-filter="PENDING" onclick="filterClaims('PENDING', this)">Pending</button>
            <button class="filter-tab" data-filter="APPROVED" onclick="filterClaims('APPROVED', this)">Approved</button>
            <button class="filter-tab" data-filter="REJECTED" onclick="filterClaims('REJECTED', this)">Rejected</button>
          </div>
        </div>
        <div class="claims-list" id="claimsList">
          <!-- Claims will be loaded here dynamically -->
        </div>
      </div>
    </div>

    <!-- Claim Forms Section (NEW) -->
    <div id="claim-forms-section" class="claim-forms-section">
      <div class="page-header">
        <h1>Available Claim Forms</h1>
      </div>
      <p style="color: #666; margin-bottom: 1rem;">Choose from admin-created forms tailored for different types of claims. Each form includes specific instructions and required fields.</p>
      <div class="forms-grid" id="formsGrid">
        <!-- Forms will be loaded here dynamically -->
      </div>
    </div>

    <!-- Submit Claim Section -->
    <div id="submit-claim-section" class="claim-form-section">
      <div class="page-header">
        <h1 id="form-title">Submit New Claim</h1>
      </div>
      <div class="form-description" id="form-instructions">
        <h3>üö® When to Submit a Claim</h3>
        <p><strong>Life throws curveballs!</strong> Whether it's a sudden collision on busy streets, unexpected vandalism while parked, or the heartbreak of vehicle theft - we've got you covered. Submit your claim when your vehicle faces accidents, damage, theft, or any incident that affects your mobility and peace of mind. Quick action means faster resolution!</p>
      </div>
      <form class="claim-form" id="claimForm" onsubmit="submitClaim(event)">
        <div id="dynamic-fields">
          <!-- Dynamic fields will be inserted here -->
        </div>

        <!-- Static fields that are always present -->
        <h3 style="color: #667eea; margin: 1.5rem 0 1rem;">Evidence Photos</h3>
        <div class="form-group">
          <label for="photos">Upload Photos (up to 5 images)</label>
          <input type="file" id="photos" multiple accept="image/*" onchange="handleFileSelect(this)">
          <div id="selectedFiles" style="margin-top: 0.5rem;"></div>
        </div>

        <button type="submit" class="submit-btn" id="submitBtn">
          üöÄ Submit Claim
        </button>
      </form>
    </div>

    <!-- Notifications Section -->
    <div id="notifications-section" class="notifications-section">
      <div class="page-header">
        <h1>Notifications</h1>
      </div>
      <div id="notificationsList">
        <!-- Notifications will be loaded here dynamically -->
      </div>
    </div>
  </div>
</div>

<!-- Notification Modal -->
<div class="modal" id="notificationModal">
  <div class="modal-content">
    <h3>Claim Submitted Successfully! üéâ</h3>
    <p>Your claim has been submitted and is being reviewed by our team. You will receive notifications about status updates.</p>
    <div class="modal-buttons">
      <button class="modal-btn confirm-btn" onclick="closeModal('notificationModal')">OK</button>
    </div>
  </div>
</div>

<!-- Notification -->
<div class="notification" id="notification"></div>

<script>
  // API Configuration
  const USER_API_BASE_URL = 'http://localhost:8080/api/user/claims';
  const CURRENT_USER_NIC = '123456789V'; // Change this to the actual logged-in user's NIC
  let allUserClaims = [];
  let selectedFiles = [];
  let availableForms = [];
  let currentSelectedForm = null;

  // Load available claim forms
  async function loadAvailableClaimForms() {
    try {
      showLoading('formsGrid');
      const response = await fetch(`${USER_API_BASE_URL}/forms`);
      if (response.ok) {
        availableForms = await response.json();
        renderClaimForms(availableForms);
      } else {
        document.getElementById('formsGrid').innerHTML = '<p style="text-align: center; padding: 2rem; color: #666;">No forms available at the moment.</p>';
      }
    } catch (error) {
      console.error('Failed to load claim forms:', error);
      document.getElementById('formsGrid').innerHTML = '<p style="text-align: center; padding: 2rem; color: #666;">Failed to load forms. Please check your connection.</p>';
    } finally {
      hideLoading('formsGrid');
    }
  }

  // Render available claim forms
  function renderClaimForms(forms) {
    const formsContainer = document.getElementById('formsGrid');

    if (!forms || forms.length === 0) {
      formsContainer.innerHTML = '<p style="text-align: center; padding: 2rem; color: #666;">No forms available. Please check back later.</p>';
      return;
    }

    formsContainer.innerHTML = forms.map(form => `
            <div class="form-card">
                <div class="form-card-header">
                    <div class="form-card-icon">üìã</div>
                    <div class="form-card-title">${form.formName}</div>
                </div>
                <div class="form-card-instructions">${form.instructions || 'Complete this form to submit your claim with all required information.'}</div>
                <div class="form-card-meta">
                    <span>üìÖ Created: ${formatDate(form.createdDate)}</span>
                    <span>üîß Fields: ${form.formFields ? form.formFields.length : 0}</span>
                </div>
                <button class="use-form-btn" onclick="useClaimForm(${form.id})">
                    Use This Form
                </button>
            </div>
        `).join('');
  }

  // Use specific claim form
  async function useClaimForm(formId) {
    try {
      const response = await fetch(`${USER_API_BASE_URL}/forms/${formId}`);
      if (response.ok) {
        currentSelectedForm = await response.json();
        generateDynamicForm(currentSelectedForm);
        showSection('submit-claim', document.querySelector('.submit-claim'));
        showNotification(`Using form: ${currentSelectedForm.formName}`, 'success');
      } else {
        showNotification('Failed to load form details', 'error');
      }
    } catch (error) {
      console.error('Failed to load form details:', error);
      showNotification('Network error loading form', 'error');
    }
  }

  // Generate dynamic form based on selected form
  function generateDynamicForm(form) {
    const dynamicFieldsContainer = document.getElementById('dynamic-fields');
    const formTitle = document.getElementById('form-title');
    const formInstructions = document.getElementById('form-instructions');

    // Update form title and instructions
    formTitle.textContent = `Submit Claim - ${form.formName}`;
    formInstructions.innerHTML = `
            <h3>üìù ${form.formName}</h3>
            <p>${form.instructions}</p>
        `;

    // Clear existing dynamic fields
    dynamicFieldsContainer.innerHTML = '';

    if (!form.formFields || form.formFields.length === 0) {
      // If no dynamic fields, show default form
      generateDefaultForm();
      return;
    }

    // Sort fields by order
    const sortedFields = form.formFields.sort((a, b) => a.fieldOrder - b.fieldOrder);

    // Group fields by sections
    let currentSection = '';
    let sectionCount = 0;

    sortedFields.forEach(field => {
      // Create section headers based on field patterns
      const fieldLabel = field.fieldLabel.toLowerCase();
      let newSection = '';

      if (fieldLabel.includes('name') || fieldLabel.includes('age') || fieldLabel.includes('nic') || fieldLabel.includes('phone') || fieldLabel.includes('email')) {
        newSection = 'Personal Details';
      } else if (fieldLabel.includes('vehicle') || fieldLabel.includes('model') || fieldLabel.includes('chassis') || fieldLabel.includes('number')) {
        newSection = 'Vehicle Information';
      } else if (fieldLabel.includes('incident') || fieldLabel.includes('date') || fieldLabel.includes('time') || fieldLabel.includes('description')) {
        newSection = 'Incident Details';
      }

      if (newSection && newSection !== currentSection) {
        currentSection = newSection;
        sectionCount++;
        dynamicFieldsContainer.innerHTML += `<h3 style="color: #667eea; margin: 1.5rem 0 1rem;">${currentSection}</h3>`;
      }

      // Create field HTML
      const fieldHTML = generateFieldHTML(field);
      dynamicFieldsContainer.innerHTML += fieldHTML;
    });
  }

  // Generate HTML for individual field
  function generateFieldHTML(field) {
    const requiredMark = field.isRequired ? '<span class="field-required">*</span>' : '';
    const requiredAttr = field.isRequired ? 'required' : '';

    let fieldHTML = '';
    const fieldId = `field_${field.id}`;

    switch (field.fieldType.toLowerCase()) {
      case 'text':
        fieldHTML = `
                    <div class="form-group dynamic-field">
                        <label for="${fieldId}">${field.fieldLabel} ${requiredMark}</label>
                        <input type="text" id="${fieldId}" name="${field.fieldLabel}" ${requiredAttr} placeholder="Enter ${field.fieldLabel.toLowerCase()}">
                    </div>
                `;
        break;

      case 'number':
        fieldHTML = `
                    <div class="form-group dynamic-field">
                        <label for="${fieldId}">${field.fieldLabel} ${requiredMark}</label>
                        <input type="number" id="${fieldId}" name="${field.fieldLabel}" ${requiredAttr} placeholder="Enter ${field.fieldLabel.toLowerCase()}">
                    </div>
                `;
        break;

      case 'date':
        fieldHTML = `
                    <div class="form-group dynamic-field">
                        <label for="${fieldId}">${field.fieldLabel} ${requiredMark}</label>
                        <input type="datetime-local" id="${fieldId}" name="${field.fieldLabel}" ${requiredAttr}>
                    </div>
                `;
        break;

      case 'textarea':
        fieldHTML = `
                    <div class="form-group dynamic-field">
                        <label for="${fieldId}">${field.fieldLabel} ${requiredMark}</label>
                        <textarea id="${fieldId}" name="${field.fieldLabel}" ${requiredAttr} placeholder="Enter ${field.fieldLabel.toLowerCase()}" rows="4"></textarea>
                    </div>
                `;
        break;

      case 'file':
        fieldHTML = `
                    <div class="form-group dynamic-field">
                        <label for="${fieldId}">${field.fieldLabel} ${requiredMark}</label>
                        <input type="file" id="${fieldId}" name="${field.fieldLabel}" ${requiredAttr} accept="image/*,application/pdf">
                    </div>
                `;
        break;

      default:
        fieldHTML = `
                    <div class="form-group dynamic-field">
                        <label for="${fieldId}">${field.fieldLabel} ${requiredMark}</label>
                        <input type="text" id="${fieldId}" name="${field.fieldLabel}" ${requiredAttr} placeholder="Enter ${field.fieldLabel.toLowerCase()}">
                    </div>
                `;
        break;
    }

    return fieldHTML;
  }

  // Generate default form when no dynamic form is selected
  function generateDefaultForm() {
    const dynamicFieldsContainer = document.getElementById('dynamic-fields');
    dynamicFieldsContainer.innerHTML = `
            <h3 style="color: #667eea; margin-bottom: 1rem;">Personal Details</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="fullName">Full Name <span class="field-required">*</span></label>
                    <input type="text" id="fullName" name="fullName" required placeholder="Enter your full name">
                </div>
                <div class="form-group">
                    <label for="age">Age <span class="field-required">*</span></label>
                    <input type="number" id="age" name="age" required min="16" max="100" placeholder="Your age">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="nic">NIC Number <span class="field-required">*</span></label>
                    <input type="text" id="nic" name="nic" required placeholder="123456789V or 199912345678">
                </div>
                <div class="form-group">
                    <label for="telephone">Telephone <span class="field-required">*</span></label>
                    <input type="tel" id="telephone" name="telephone" required placeholder="+94 77 123 4567">
                </div>
            </div>
            <div class="form-group">
                <label for="email">Email Address <span class="field-required">*</span></label>
                <input type="email" id="email" name="email" required placeholder="your.email@example.com">
            </div>

            <h3 style="color: #667eea; margin: 1.5rem 0 1rem;">Incident Details</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="incidentType">Type of Incident <span class="field-required">*</span></label>
                    <select id="incidentType" name="incidentType" required>
                        <option value="">Select incident type</option>
                        <option value="Accident">üöó Vehicle Accident</option>
                        <option value="Theft">üîí Vehicle Theft</option>
                        <option value="Vandalism">üî® Vandalism/Damage</option>
                        <option value="Fire">üî• Fire Damage</option>
                        <option value="Flood">üåä Flood Damage</option>
                        <option value="Other">‚ùì Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="incidentDate">Date & Time of Incident <span class="field-required">*</span></label>
                    <input type="datetime-local" id="incidentDate" name="incidentDate" required>
                </div>
            </div>

            <h3 style="color: #667eea; margin: 1.5rem 0 1rem;">Vehicle Information</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="vehicleNumber">Vehicle Number <span class="field-required">*</span></label>
                    <input type="text" id="vehicleNumber" name="vehicleNumber" required placeholder="WP CAR 1234" style="text-transform: uppercase;">
                </div>
                <div class="form-group">
                    <label for="vehicleModel">Vehicle Model <span class="field-required">*</span></label>
                    <input type="text" id="vehicleModel" name="vehicleModel" required placeholder="Toyota Prius 2020">
                </div>
            </div>
            <div class="form-group">
                <label for="chassisNumber">Chassis Number <span class="field-required">*</span></label>
                <input type="text" id="chassisNumber" name="chassisNumber" required placeholder="JT2BK18U8X0123456">
            </div>

            <h3 style="color: #667eea; margin: 1.5rem 0 1rem;">Incident Description</h3>
            <div class="form-group">
                <label for="description">Detailed Description <span class="field-required">*</span></label>
                <textarea id="description" name="description" required placeholder="Please describe what happened in detail. Include time, location, people involved, and any other relevant information..." rows="5"></textarea>
            </div>
        `;
  }

  // Load user statistics
  async function loadUserStatistics() {
    try {
      const response = await fetch(`${USER_API_BASE_URL}/user/${CURRENT_USER_NIC}/statistics`);
      if (response.ok) {
        const stats = await response.json();
        document.getElementById('pendingCount').textContent = stats.pending || 0;
        document.getElementById('approvedCount').textContent = stats.approved || 0;
        document.getElementById('rejectedCount').textContent = stats.rejected || 0;
        document.getElementById('totalCount').textContent = stats.total || 0;
      }
    } catch (error) {
      console.error('Failed to load user statistics:', error);
      showNotification('Failed to load statistics', 'error');
    }
  }

  // Load user claims
  async function loadUserClaims() {
    try {
      showLoading('claimsList');
      const response = await fetch(`${USER_API_BASE_URL}/user/${CURRENT_USER_NIC}`);
      if (response.ok) {
        allUserClaims = await response.json();
        renderUserClaims(allUserClaims);
      } else {
        document.getElementById('claimsList').innerHTML = '<p style="text-align: center; padding: 2rem; color: #666;">No claims found.</p>';
      }
    } catch (error) {
      console.error('Failed to load user claims:', error);
      document.getElementById('claimsList').innerHTML = '<p style="text-align: center; padding: 2rem; color: #666;">Failed to load claims. Please check your connection.</p>';
    } finally {
      hideLoading('claimsList');
    }
  }

  // Load user claims by status
  async function loadUserClaimsByStatus(status) {
    try {
      showLoading('claimsList');
      const response = await fetch(`${USER_API_BASE_URL}/user/${CURRENT_USER_NIC}/status/${status}`);
      if (response.ok) {
        const claims = await response.json();
        renderUserClaims(claims);
      } else {
        document.getElementById('claimsList').innerHTML = '<p style="text-align: center; padding: 2rem; color: #666;">No claims found.</p>';
      }
    } catch (error) {
      console.error(`Failed to load ${status} claims:`, error);
      document.getElementById('claimsList').innerHTML = `<p style="text-align: center; padding: 2rem; color: #666;">Failed to load ${status} claims.</p>`;
    } finally {
      hideLoading('claimsList');
    }
  }

  // Load user notifications
  async function loadUserNotifications() {
    try {
      showLoading('notificationsList');
      const response = await fetch(`${USER_API_BASE_URL}/user/${CURRENT_USER_NIC}/notifications`);
      if (response.ok) {
        const notifications = await response.json();
        renderNotifications(notifications);
      } else {
        document.getElementById('notificationsList').innerHTML = '<p style="text-align: center; padding: 2rem; color: #666;">No notifications found.</p>';
      }
    } catch (error) {
      console.error('Failed to load notifications:', error);
      document.getElementById('notificationsList').innerHTML = '<p style="text-align: center; padding: 2rem; color: #666;">Failed to load notifications.</p>';
    } finally {
      hideLoading('notificationsList');
    }
  }

  // Submit claim
  async function submitClaim(event) {
    event.preventDefault();

    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.textContent = '‚è≥ Submitting...';

    try {
      // Collect form data dynamically
      const formData = new FormData(event.target);
      const claimData = {};

      for (let [key, value] of formData.entries()) {
        if (key !== 'photos') { // Handle photos separately
          claimData[key] = value;
        }
      }

      // Map common field names to expected API format
      const fieldMapping = {
        'Full Name': 'fullName',
        'Age': 'age',
        'NIC Number': 'nic',
        'Telephone': 'phone',
        'Email Address': 'email',
        'Vehicle Number': 'vehicleNumber',
        'Vehicle Model': 'vehicleModel',
        'Chassis Number': 'chassisNumber',
        'Date & Time of Incident': 'incidentDate',
        'Type of Incident': 'incidentType',
        'Detailed Description': 'description'
      };

      // Convert field names to API format
      const apiData = {};
      for (let [key, value] of Object.entries(claimData)) {
        const apiKey = fieldMapping[key] || key;
        apiData[apiKey] = value;
      }

      // Ensure required fields have values
      if (!apiData.fullName) apiData.fullName = claimData.fullName || claimData['Full Name'];
      if (!apiData.age) apiData.age = parseInt(claimData.age || claimData['Age']);
      if (!apiData.nic) apiData.nic = claimData.nic || claimData['NIC Number'];
      if (!apiData.phone) apiData.phone = claimData.telephone || claimData['Telephone'];
      if (!apiData.email) apiData.email = claimData.email || claimData['Email Address'];

      console.log('Submitting claim:', apiData);

      const response = await fetch(`${USER_API_BASE_URL}/submit`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify(apiData)
      });

      if (response.ok) {
        const result = await response.json();
        console.log('Claim submitted successfully:', result);

        // Show success modal
        document.getElementById('notificationModal').classList.add('active');

        // Reset form
        document.getElementById('claimForm').reset();
        selectedFiles = [];
        updateFileDisplay();

        // Show success notification
        showNotification('Claim submitted successfully! üéâ', 'success');

        // Refresh data
        await loadUserStatistics();
        await loadUserClaims();

      } else {
        const errorText = await response.text();
        console.error('Failed to submit claim:', errorText);
        showNotification('Failed to submit claim. Please try again.', 'error');
      }
    } catch (error) {
      console.error('Error submitting claim:', error);
      showNotification('Network error. Please check your connection.', 'error');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'üöÄ Submit Claim';
    }
  }

  // Render user claims
  function renderUserClaims(claims) {
    const claimsContainer = document.getElementById('claimsList');

    if (!claims || claims.length === 0) {
      claimsContainer.innerHTML = '<p style="text-align: center; padding: 2rem; color: #666;">No claims found.</p>';
      return;
    }

    claimsContainer.innerHTML = claims.map(claim => `
            <div class="claim-item" data-status="${claim.status}" data-claim-id="${claim.id}">
                <div class="claim-header" onclick="toggleClaim(this)">
                    <div class="claim-info">
                        <div class="claim-id">Claim #${claim.claimNumber}</div>
                        <div class="claim-meta">
                            <span>üìÖ ${formatDate(claim.submittedDate)}</span>
                            <span>üöó ${claim.incidentType}</span>
                            <span>üöô ${claim.vehicleNumber}</span>
                        </div>
                    </div>
                    <div class="claim-status status-${claim.status.toLowerCase()}">
                        ${claim.status}
                    </div>
                    <div class="expand-icon">‚ñº</div>
                </div>
                <div class="claim-details">
                    <div class="details-grid">
                        <div class="detail-section">
                            <h4>Personal Information</h4>
                            <div class="detail-item"><span class="detail-label">Full Name:</span> ${claim.fullName}</div>
                            <div class="detail-item"><span class="detail-label">Age:</span> ${claim.age}</div>
                            <div class="detail-item"><span class="detail-label">NIC:</span> ${claim.nic}</div>
                            <div class="detail-item"><span class="detail-label">Phone:</span> ${claim.phone}</div>
                            <div class="detail-item"><span class="detail-label">Email:</span> ${claim.email}</div>
                        </div>
                        <div class="detail-section">
                            <h4>Vehicle Information</h4>
                            <div class="detail-item"><span class="detail-label">Vehicle No:</span> ${claim.vehicleNumber}</div>
                            <div class="detail-item"><span class="detail-label">Model:</span> ${claim.vehicleModel}</div>
                            <div class="detail-item"><span class="detail-label">Chassis No:</span> ${claim.chassisNumber}</div>
                            <div class="detail-item"><span class="detail-label">Incident Date:</span> ${formatDateTime(claim.incidentDate)}</div>
                        </div>
                        <div class="detail-section description-section">
                            <h4>Incident Description</h4>
                            <div class="description-text">"${claim.description}"</div>
                        </div>
                    </div>
                    <div class="photos-section">
                        <h4>Incident Photos</h4>
                        <div class="photos-grid">
                            <div style="color: #666; font-style: italic; padding: 1rem; text-align: center; border: 2px dashed #ddd; border-radius: 8px;">Photos will be displayed here</div>
                        </div>
                    </div>
                    ${renderStatusMessage(claim)}
                </div>
            </div>
        `).join('');
  }

  // Render status message
  function renderStatusMessage(claim) {
    if (claim.status === 'APPROVED') {
      return `
                <div class="status-message approved">
                    ‚úÖ Claim Approved${claim.adminReason ? ' - ' + claim.adminReason : ' - Processing payment'}
                </div>
            `;
    } else if (claim.status === 'REJECTED') {
      return `
                <div class="status-message rejected">
                    ‚ùå Claim Rejected${claim.adminReason ? ' - ' + claim.adminReason : ' - Please contact support'}
                </div>
            `;
    }
    return '';
  }

  // Render notifications
  function renderNotifications(notifications) {
    const notificationsContainer = document.getElementById('notificationsList');

    if (!notifications || notifications.length === 0) {
      notificationsContainer.innerHTML = '<p style="text-align: center; padding: 2rem; color: #666;">No notifications found.</p>';
      return;
    }

    notificationsContainer.innerHTML = notifications.map(notification => `
            <div class="notification-item ${!notification.isRead ? 'new' : ''}" onclick="markNotificationAsRead(${notification.id})">
                <div class="notification-icon">
                    ${getNotificationIcon(notification.type)}
                </div>
                <div class="notification-content">
                    <div class="notification-title">${notification.title}</div>
                    <div class="notification-text">${notification.message}</div>
                    <div class="notification-time">${formatDateTime(notification.createdDate)}</div>
                </div>
            </div>
        `).join('');
  }

  // Mark notification as read
  async function markNotificationAsRead(notificationId) {
    try {
      await fetch(`${USER_API_BASE_URL}/notifications/${notificationId}/read`, {
        method: 'PUT'
      });
      // Refresh notifications after marking as read
      loadUserNotifications();
    } catch (error) {
      console.error('Failed to mark notification as read:', error);
    }
  }

  // Get notification icon based on type
  function getNotificationIcon(type) {
    switch (type) {
      case 'CLAIM_SUBMITTED': return 'üìù';
      case 'CLAIM_APPROVED': return '‚úÖ';
      case 'CLAIM_REJECTED': return '‚ùå';
      default: return 'üîî';
    }
  }

  // File handling
  function handleFileSelect(input) {
    const files = Array.from(input.files);
    if (files.length > 5) {
      showNotification('Maximum 5 files allowed', 'error');
      input.value = '';
      return;
    }

    selectedFiles = files;
    updateFileDisplay();
  }

  function updateFileDisplay() {
    const container = document.getElementById('selectedFiles');
    if (selectedFiles.length === 0) {
      container.innerHTML = '';
      return;
    }

    container.innerHTML = `
            <div style="border: 1px solid #e1e5f2; border-radius: 8px; padding: 1rem; margin-top: 0.5rem;">
                <h4 style="margin-bottom: 0.5rem; color: #667eea;">Selected Files (${selectedFiles.length}/5):</h4>
                ${selectedFiles.map(file => `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                        <span style="font-size: 0.9rem;">${file.name}</span>
                        <span style="font-size: 0.8rem; color: #666;">${(file.size / 1024 / 1024).toFixed(2)} MB</span>
                    </div>
                `).join('')}
            </div>
        `;
  }

  // UI Functions
  function showSection(section, element) {
    document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
    element.classList.add('active');

    document.getElementById('overview-section').style.display = section === 'overview' ? 'block' : 'none';
    document.getElementById('claim-forms-section').style.display = section === 'claim-forms' ? 'block' : 'none';
    document.getElementById('submit-claim-section').style.display = section === 'submit-claim' ? 'block' : 'none';
    document.getElementById('notifications-section').style.display = section === 'notifications' ? 'block' : 'none';

    if (section === 'overview') {
      loadUserStatistics();
      loadUserClaims();
    } else if (section === 'claim-forms') {
      loadAvailableClaimForms();
    } else if (section === 'submit-claim') {
      // Load default form if no form is selected
      if (!currentSelectedForm) {
        generateDefaultForm();
        document.getElementById('form-title').textContent = 'Submit New Claim - Quick Form';
        document.getElementById('form-instructions').innerHTML = `
                    <h3>üö® Quick Claim Submission</h3>
                    <p><strong>Life throws curveballs!</strong> Whether it's a sudden collision on busy streets, unexpected vandalism while parked, or the heartbreak of vehicle theft - we've got you covered. Submit your claim when your vehicle faces accidents, damage, theft, or any incident that affects your mobility and peace of mind. Quick action means faster resolution!</p>
                `;
      }
    } else if (section === 'notifications') {
      loadUserNotifications();
    }
  }

  function toggleClaim(element) {
    const item = element.parentElement;
    item.classList.toggle('expanded');
  }

  async function filterClaims(filter, element) {
    document.querySelectorAll('.filter-tab').forEach(tab => tab.classList.remove('active'));
    element.classList.add('active');

    if (filter === 'all') {
      await loadUserClaims();
    } else {
      await loadUserClaimsByStatus(filter);
    }
  }

  function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
  }

  function showNotification(message, type) {
    const notif = document.getElementById('notification');
    notif.textContent = message;
    notif.classList.add('show', type);
    setTimeout(() => notif.classList.remove('show', type), 5000);
  }

  function showLoading(elementId) {
    const element = document.getElementById(elementId);
    element.classList.add('loading');
  }

  function hideLoading(elementId) {
    const element = document.getElementById(elementId);
    element.classList.remove('loading');
  }

  async function refreshDashboard() {
    showNotification('Refreshing dashboard...', 'info');
    await loadUserStatistics();
    await loadUserClaims();
    await loadAvailableClaimForms();
  }

  function logout() {
    if (confirm('Are you sure you want to logout?')) {
      showNotification('Logging out...', 'info');
      // Implement logout logic here
    }
  }

  // Utility Functions
  function formatDate(dateString) {
    if (!dateString) return 'N/A';
    try {
      const date = new Date(dateString);
      return date.toLocaleDateString();
    } catch (error) {
      return 'Invalid Date';
    }
  }

  function formatDateTime(dateString) {
    if (!dateString) return 'N/A';
    try {
      const date = new Date(dateString);
      return date.toLocaleString();
    } catch (error) {
      return 'Invalid Date';
    }
  }

  // Initialize the application
  document.addEventListener('DOMContentLoaded', function() {
    console.log('Initializing MotorCare User Claims Dashboard');
    const overviewButton = document.querySelector('.menu-item.overview');
    showSection('overview', overviewButton);

    // Load available forms on startup
    loadAvailableClaimForms();

    // Test API connection
    loadUserStatistics().then(() => {
      console.log('Successfully connected to backend API');
    }).catch(() => {
      console.warn('Backend API not available - Check if Spring Boot is running on localhost:8080');
      showNotification('Please start the backend server for full functionality', 'info');
    });
  });
</script>
</body>
</html>
