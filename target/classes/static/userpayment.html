<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Payments - MOTORCARE LK</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .header {
            background: white;
            padding: 15px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .dashboard-btn {
            background: #e8eaf6;
            color: #667eea;
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s;
        }

        .dashboard-btn:hover {
            background: #667eea;
            color: white;
        }

        .logout-btn {
            background: #ff5252;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: #ff1744;
        }

        .container {
            display: flex;
            min-height: calc(100vh - 70px);
        }

        .sidebar {
            width: 280px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            padding: 30px 20px;
            color: white;
        }

        .sidebar-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .sidebar-subtitle {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 30px;
        }

        .menu-item {
            padding: 15px 20px;
            margin-bottom: 10px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
        }

        .menu-item:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .menu-item.active {
            background: rgba(255, 255, 255, 0.25);
        }

        .main-content {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
        }

        .content-header {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .content-title {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 28px;
            font-weight: bold;
            color: #333;
            margin-bottom: 30px;
        }

        .policy-card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border-left: 5px solid #667eea;
        }

        .policy-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .policy-info h3 {
            color: #333;
            margin-bottom: 5px;
        }

        .policy-info p {
            color: #666;
            font-size: 14px;
        }

        .policy-status {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            background: #d4edda;
            color: #155724;
        }

        .payment-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .payment-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
        }

        .section-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .months-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        .month-badge {
            padding: 8px 12px;
            border-radius: 8px;
            text-align: center;
            font-size: 12px;
            font-weight: 600;
        }

        .month-paid {
            background: #d4edda;
            color: #155724;
        }

        .month-pending {
            background: #f8d7da;
            color: #721c24;
        }

        .pay-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
        }

        .pay-btn:hover {
            background: #5568d3;
        }

        .pay-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .payment-history {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-top: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .history-table th,
        .history-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }

        .history-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-approved {
            background: #d4edda;
            color: #155724;
        }

        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 25px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: bold;
        }

        .close-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s;
        }

        .close-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .modal-body {
            padding: 25px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .payment-method-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .tab-button {
            flex: 1;
            padding: 12px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }

        .tab-button.active {
            color: #667eea;
            border-bottom: 2px solid #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .bank-details {
            background: #e8f4fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .bank-details h4 {
            color: #1565c0;
            margin-bottom: 10px;
        }

        .bank-details p {
            margin-bottom: 5px;
            font-size: 14px;
            color: #333;
        }

        .file-upload {
            border: 2px dashed #ccc;
            padding: 20px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-upload:hover {
            border-color: #667eea;
        }

        .file-upload.dragover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .submit-btn {
            background: #4caf50;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
            transition: all 0.3s;
        }

        .submit-btn:hover {
            background: #45a049;
        }

        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .update-btn {
            background: #ff9800;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
            transition: all 0.3s;
        }

        .update-btn:hover {
            background: #f57c00;
        }

        .countdown-timer {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            border: 2px solid #ffeeba;
        }

        .countdown-text {
            font-size: 14px;
            color: #856404;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .countdown-time {
            font-size: 24px;
            font-weight: bold;
            color: #856404;
            font-family: 'Courier New', monospace;
        }

        .countdown-expired {
            background: #f8d7da;
            border-color: #f5c6cb;
        }

        .countdown-expired .countdown-text,
        .countdown-expired .countdown-time {
            color: #721c24;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .edit-btn {
            background: #ff9800;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            flex: 1;
            transition: all 0.3s;
        }

        .edit-btn:hover {
            background: #f57c00;
        }

        .edit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .delete-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            flex: 1;
            transition: all 0.3s;
        }

        .delete-btn:hover {
            background: #d32f2f;
        }

        .delete-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .view-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .view-btn:hover {
            background: #1976D2;
        }

        .timer-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
            font-size: 11px;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }

        .timer-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #f5c6cb;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #c3e6cb;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state h3 {
            margin-bottom: 10px;
        }

        .empty-state p {
            font-size: 14px;
        }

        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            z-index: 2000;
            cursor: pointer;
        }

        .status-online {
            background: #d4edda;
            color: #155724;
        }

        .status-offline {
            background: #f8d7da;
            color: #721c24;
        }

        .refresh-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            margin-left: 10px;
            transition: all 0.3s;
        }

        .refresh-btn:hover {
            background: #218838;
        }
    </style>
</head>
<body>
<div id="connectionStatus" class="connection-status status-offline">Backend Offline</div>

<div class="header">
    <div class="logo">
        <div class="logo-icon">🚗</div>
        MOTORCARE LK
    </div>
    <div class="header-actions">
        <a href="#" class="dashboard-btn">Dashboard</a>
        <button class="logout-btn">Logout</button>
    </div>
</div>

<div class="container">
    <div class="sidebar">
        <div class="sidebar-title">👤 User Panel</div>
        <div class="sidebar-subtitle">Payment Management</div>

        <div class="menu-item active" onclick="setActiveTab(this, 'policies')">📋 My Policies</div>
        <div class="menu-item" onclick="setActiveTab(this, 'history')">📊 Payment History</div>
        <div class="menu-item" onclick="setActiveTab(this, 'pending')">⏳ Pending Payments</div>
    </div>

    <div class="main-content">
        <div class="content-header">
            <div class="content-title">
                <span>💳</span> My Payment Dashboard
            </div>
        </div>

        <!-- Policies Section -->
        <div id="policiesSection">
            <div id="loadingPolicies" class="loading">Loading your policies...</div>
            <div id="policiesContainer"></div>
        </div>

        <!-- Payment History Section -->
        <div class="payment-history" id="historySection" style="display: none;">
            <h3>Payment History
                <button class="refresh-btn" onclick="forceRefreshHistory()">Refresh</button>
            </h3>
            <div id="loadingHistory" class="loading">Loading payment history...</div>
            <table class="history-table" id="historyTable" style="display: none;">
                <thead>
                <tr>
                    <th>Payment ID</th>
                    <th>Policy</th>
                    <th>Month</th>
                    <th>Amount</th>
                    <th>Method</th>
                    <th>Status</th>
                    <th>Date</th>
                    <th>Time Left</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody id="historyTableBody">
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Payment Modal -->
<div id="paymentModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">Make Payment</div>
            <button class="close-btn" onclick="closeModal('paymentModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div id="paymentForm">
                <div class="form-group">
                    <label class="form-label">Policy Number</label>
                    <input type="text" id="policyNumber" class="form-input" readonly>
                </div>

                <div class="form-group">
                    <label class="form-label">Payment Month</label>
                    <select id="paymentMonth" class="form-input">
                        <option value="">Select Month</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Amount (LKR)</label>
                    <input type="number" id="paymentAmount" class="form-input" readonly>
                </div>

                <div class="payment-method-tabs">
                    <button class="tab-button active" onclick="switchTab(this, 'bankSlip')">Bank Slip</button>
                    <button class="tab-button" onclick="switchTab(this, 'online')">Online Payment</button>
                </div>

                <!-- Bank Slip Tab -->
                <div id="bankSlipTab" class="tab-content active">
                    <div class="bank-details">
                        <h4>Company Bank Details</h4>
                        <p><strong>Bank:</strong> <span id="bankName">Commercial Bank of Ceylon PLC</span></p>
                        <p><strong>Account Number:</strong> <span id="accountNumber">8001234567890</span></p>
                        <p><strong>Account Name:</strong> <span id="accountName">MOTORCARE LK (PVT) LTD</span></p>
                        <p><strong>Branch:</strong> <span id="branchName">Colombo 03</span></p>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Depositor Name</label>
                        <input type="text" id="depositorName" class="form-input" placeholder="Enter depositor name">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Deposit Date</label>
                        <input type="date" id="depositDate" class="form-input">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Reference Number</label>
                        <input type="text" id="referenceNumber" class="form-input" placeholder="Enter bank reference number">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Upload Bank Slip</label>
                        <div class="file-upload" onclick="document.getElementById('bankSlipFile').click()">
                            <p>Click to upload bank slip or drag and drop</p>
                            <input type="file" id="bankSlipFile" accept="image/*" style="display: none;" onchange="handleFileUpload(this)">
                        </div>
                        <div id="filePreview" style="display: none; margin-top: 10px;">
                            <img id="previewImage" style="max-width: 200px; border-radius: 8px;">
                        </div>
                    </div>
                </div>

                <!-- Online Payment Tab -->
                <div id="onlineTab" class="tab-content">
                    <div class="form-group">
                        <label class="form-label">Cardholder Name</label>
                        <input type="text" id="cardholderName" class="form-input" placeholder="Enter cardholder name">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Card Number</label>
                        <input type="text" id="cardNumber" class="form-input" placeholder="1234 5678 9012 3456" maxlength="23">
                    </div>

                    <div style="display: flex; gap: 15px;">
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label">Expiry Date</label>
                            <input type="text" id="expiryDate" class="form-input" placeholder="MM/YY" maxlength="5">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label">CVC</label>
                            <input type="text" id="cvcCode" class="form-input" placeholder="123" maxlength="4">
                        </div>
                    </div>
                </div>

                <button class="submit-btn" onclick="submitPayment()" id="submitPaymentBtn">
                    Submit Payment
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Payment Modal -->
<div id="editPaymentModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">Edit Payment</div>
            <button class="close-btn" onclick="closeModal('editPaymentModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div id="editPaymentForm">
                <!-- Countdown Timer -->
                <div id="editCountdownTimer" class="countdown-timer">
                    <div class="countdown-text">Time remaining to edit this payment</div>
                    <div class="countdown-time" id="editCountdownDisplay">00:00:00</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Payment ID</label>
                    <input type="text" id="editPaymentId" class="form-input" readonly>
                </div>

                <div class="form-group">
                    <label class="form-label">Policy Number</label>
                    <input type="text" id="editPolicyNumber" class="form-input" readonly>
                </div>

                <div class="form-group">
                    <label class="form-label">Payment Month</label>
                    <select id="editPaymentMonth" class="form-input">
                        <option value="">Select Month</option>
                        <option value="January">January</option>
                        <option value="February">February</option>
                        <option value="March">March</option>
                        <option value="April">April</option>
                        <option value="May">May</option>
                        <option value="June">June</option>
                        <option value="July">July</option>
                        <option value="August">August</option>
                        <option value="September">September</option>
                        <option value="October">October</option>
                        <option value="November">November</option>
                        <option value="December">December</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Amount (LKR)</label>
                    <input type="number" id="editPaymentAmount" class="form-input" step="0.01" min="0">
                </div>

                <div class="payment-method-tabs">
                    <button class="tab-button active" onclick="switchEditTab(this, 'bankSlip')">Bank Slip</button>
                    <button class="tab-button" onclick="switchEditTab(this, 'online')">Online Payment</button>
                </div>

                <!-- Bank Slip Tab -->
                <div id="editBankSlipTab" class="tab-content active">
                    <div class="form-group">
                        <label class="form-label">Depositor Name</label>
                        <input type="text" id="editDepositorName" class="form-input" placeholder="Enter depositor name">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Deposit Date</label>
                        <input type="date" id="editDepositDate" class="form-input">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Reference Number</label>
                        <input type="text" id="editReferenceNumber" class="form-input" placeholder="Enter bank reference number">
                    </div>
                </div>

                <!-- Online Payment Tab -->
                <div id="editOnlineTab" class="tab-content">
                    <div class="form-group">
                        <label class="form-label">Cardholder Name</label>
                        <input type="text" id="editCardholderName" class="form-input" placeholder="Enter cardholder name">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Card Number</label>
                        <input type="text" id="editCardNumber" class="form-input" placeholder="1234 5678 9012 3456" maxlength="23">
                    </div>

                    <div style="display: flex; gap: 15px;">
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label">Expiry Date</label>
                            <input type="text" id="editExpiryDate" class="form-input" placeholder="MM/YY" maxlength="5">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label">CVC</label>
                            <input type="text" id="editCvcCode" class="form-input" placeholder="123" maxlength="4">
                        </div>
                    </div>
                </div>

                <button class="update-btn" onclick="updatePayment()" id="updatePaymentBtn">
                    Update Payment
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Payment Details Modal -->
<div id="paymentDetailsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">Payment Details</div>
            <button class="close-btn" onclick="closeModal('paymentDetailsModal')">&times;</button>
        </div>
        <div class="modal-body" id="paymentDetailsBody">
            <!-- Dynamic content will be inserted here -->
        </div>
    </div>
</div>

<script>
    // FIXED API Configuration - Using the UPDATED controller endpoints
    const API_BASE_URL = 'http://localhost:8080/api/user/payments';
    const CURRENT_USER_ID = 1;

    let currentPolicies = [];
    let currentPayments = [];
    let selectedPolicy = null;
    let selectedPayment = null;
    let bankDetails = {};
    let isBackendConnected = false;
    let countdownTimers = {};
    let refreshAttempts = 0;
    const MAX_REFRESH_ATTEMPTS = 3;

    // Initialize the application
    document.addEventListener('DOMContentLoaded', function() {
        console.log('🚀 Application starting...');
        checkBackendConnection();
        setupEventListeners();
    });

    // Enhanced backend connection check
    async function checkBackendConnection() {
        console.log('🔄 Checking backend connection...');

        try {
            const testResponse = await fetch(`${API_BASE_URL}/test-connection`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                }
            });

            if (testResponse.ok) {
                isBackendConnected = true;
                updateConnectionStatus('online');
                console.log('🎉 Backend connection successful!');

                await Promise.all([
                    loadBankDetails(),
                    loadUserPolicies()
                ]);
            } else {
                throw new Error(`Test connection failed with status: ${testResponse.status}`);
            }
        } catch (error) {
            isBackendConnected = false;
            updateConnectionStatus('offline');
            console.error('❌ Backend connection failed:', error.message);
            showError('Cannot connect to server. Please check if the backend is running on localhost:8080');
        }
    }

    // Update connection status indicator
    function updateConnectionStatus(status) {
        const statusElement = document.getElementById('connectionStatus');
        if (status === 'online') {
            statusElement.textContent = 'Backend Online';
            statusElement.className = 'connection-status status-online';
        } else {
            statusElement.textContent = 'Backend Offline';
            statusElement.className = 'connection-status status-offline';
        }
    }

    // Load user's approved policies with payment information
    async function loadUserPolicies() {
        if (!isBackendConnected) {
            document.getElementById('loadingPolicies').style.display = 'none';
            document.getElementById('policiesContainer').innerHTML = `
                <div class="empty-state">
                    <h3>Backend Connection Required</h3>
                    <p>Please ensure the backend server is running on localhost:8080</p>
                </div>
            `;
            return;
        }

        try {
            document.getElementById('loadingPolicies').style.display = 'block';

            const response = await fetch(`${API_BASE_URL}/policies/${CURRENT_USER_ID}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const policies = await response.json();
            currentPolicies = policies;
            displayPolicies(policies);

        } catch (error) {
            console.error('❌ Error loading policies:', error);
            document.getElementById('loadingPolicies').style.display = 'none';

            document.getElementById('policiesContainer').innerHTML = `
                <div class="empty-state">
                    <h3>No Policies Found</h3>
                    <p>No approved policies available for payments.</p>
                    <button class="refresh-btn" onclick="loadUserPolicies()">Try Again</button>
                </div>
            `;
        }
    }

    // FIXED - Enhanced payment history loading with WORKING fetch
    async function loadPaymentHistory() {
        if (!isBackendConnected) {
            document.getElementById('loadingHistory').style.display = 'none';
            displayPaymentHistory([]);
            showError('Backend not connected. Cannot load payment history.');
            return;
        }

        try {
            document.getElementById('loadingHistory').style.display = 'block';
            document.getElementById('historyTable').style.display = 'none';

            console.log('📊 FETCHING: Payment history for user', CURRENT_USER_ID);

            const response = await fetch(`${API_BASE_URL}/history/${CURRENT_USER_ID}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    'Cache-Control': 'no-cache'
                }
            });

            console.log('📊 RESPONSE STATUS:', response.status);

            if (!response.ok) {
                const errorText = await response.text();
                console.error('📊 RESPONSE ERROR:', errorText);
                throw new Error(`HTTP error! status: ${response.status}, response: ${errorText}`);
            }

            const responseText = await response.text();
            console.log('📊 RAW RESPONSE:', responseText);

            let payments;
            try {
                payments = JSON.parse(responseText);
                console.log('📊 PARSED PAYMENTS:', payments);
            } catch (parseError) {
                console.error('📊 PARSE ERROR:', parseError);
                throw new Error('Invalid JSON response from server');
            }

            if (!Array.isArray(payments)) {
                console.warn('📊 WARNING: Response is not an array, converting...');
                payments = [];
            }

            // Process payments to ensure they have proper structure
            const processedPayments = payments.map(payment => {
                // Handle both simple JSON object and full Payment object
                const processedPayment = {
                    paymentId: payment.paymentId || payment.id,
                    paymentMonth: payment.paymentMonth,
                    amount: payment.amount,
                    paymentMethod: payment.paymentMethod,
                    status: payment.status || 'PENDING',
                    submittedDate: payment.submittedDate,
                    expiryTime: payment.expiryTime,
                    policy: payment.policy || { id: null, policyNumber: 'N/A' }
                };

                // Ensure expiry time exists for pending payments
                if (processedPayment.status === 'PENDING' && !processedPayment.expiryTime && processedPayment.submittedDate) {
                    const submittedDate = new Date(processedPayment.submittedDate);
                    processedPayment.expiryTime = new Date(submittedDate.getTime() + 12 * 60 * 60 * 1000).toISOString();
                }

                return processedPayment;
            });

            currentPayments = processedPayments;
            console.log('📊 PROCESSED PAYMENTS:', processedPayments);
            displayPaymentHistory(processedPayments);

        } catch (error) {
            console.error('❌ Error loading payment history:', error);
            document.getElementById('loadingHistory').style.display = 'none';
            showError(`Failed to load payment history: ${error.message}`);
            displayPaymentHistory([]);
        }
    }

    // Force refresh payment history
    async function forceRefreshHistory() {
        refreshAttempts++;

        if (refreshAttempts > MAX_REFRESH_ATTEMPTS) {
            showError('Max refresh attempts reached. Please try again later.');
            refreshAttempts = 0;
            return;
        }

        console.log('🔄 Force refreshing payment history...');
        await loadPaymentHistory();
    }

    // Load bank details
    async function loadBankDetails() {
        if (!isBackendConnected) {
            bankDetails = {
                bankName: "Commercial Bank of Ceylon PLC",
                accountNumber: "8001234567890",
                accountName: "MOTORCARE LK (PVT) LTD",
                branch: "Colombo 03"
            };
            updateBankDetailsUI();
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/bank-details`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const details = await response.json();
            bankDetails = details;
            updateBankDetailsUI();

        } catch (error) {
            console.error('❌ Error loading bank details:', error);
            bankDetails = {
                bankName: "Commercial Bank of Ceylon PLC",
                accountNumber: "8001234567890",
                accountName: "MOTORCARE LK (PVT) LTD",
                branch: "Colombo 03"
            };
            updateBankDetailsUI();
        }
    }

    // Display policies
    function displayPolicies(policies) {
        const container = document.getElementById('policiesContainer');
        const loading = document.getElementById('loadingPolicies');

        loading.style.display = 'none';

        if (!Array.isArray(policies) || policies.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <h3>No Approved Policies Found</h3>
                    <p>You don't have any approved policies yet. Please contact admin to approve your policies.</p>
                    <button class="refresh-btn" onclick="loadUserPolicies()">Refresh Policies</button>
                </div>
            `;
            return;
        }

        container.innerHTML = policies.map(policy => `
            <div class="policy-card">
                <div class="policy-header">
                    <div class="policy-info">
                        <h3>${policy.policyNumber || 'POL-' + policy.policyId} - ${policy.policyType || 'Insurance Policy'}</h3>
                        <p>Vehicle: ${policy.vehicle || 'N/A'}</p>
                        <p>Monthly Premium: LKR ${policy.monthlyPremium ? Number(policy.monthlyPremium).toFixed(2) : '0.00'}</p>
                    </div>
                    <span class="policy-status">${policy.status || 'ACTIVE'}</span>
                </div>

                <div class="payment-grid">
                    <div class="payment-section">
                        <div class="section-title">
                            ✅ Paid Months
                        </div>
                        <div class="months-grid">
                            ${policy.paidMonths && policy.paidMonths.length > 0 ?
            policy.paidMonths.map(month =>
                `<div class="month-badge month-paid">${month}</div>`
            ).join('') :
            '<div style="color: #999; font-size: 12px;">No payments yet</div>'
        }
                        </div>
                    </div>

                    <div class="payment-section">
                        <div class="section-title">
                            ⏳ Pending Months
                        </div>
                        <div class="months-grid">
                            ${policy.pendingMonths && policy.pendingMonths.length > 0 ?
            policy.pendingMonths.map(month =>
                `<div class="month-badge month-pending">${month}</div>`
            ).join('') :
            '<div style="color: #999; font-size: 12px;">All months paid</div>'
        }
                        </div>
                        ${policy.pendingMonths && policy.pendingMonths.length > 0 ?
            `<button class="pay-btn" onclick="openPaymentModal(${JSON.stringify(policy).replace(/"/g, '&quot;')})">
                                Make Payment
                            </button>` :
            `<button class="pay-btn" disabled>All Payments Complete</button>`
        }
                    </div>
                </div>
            </div>
        `).join('');
    }

    // FIXED - Display payment history with proper data handling
    function displayPaymentHistory(payments) {
        const loading = document.getElementById('loadingHistory');
        const table = document.getElementById('historyTable');
        const tbody = document.getElementById('historyTableBody');

        loading.style.display = 'none';
        table.style.display = 'table';

        if (!Array.isArray(payments) || payments.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="9" style="text-align: center; padding: 40px; color: #999;">
                        No payment history found
                        <br><small>Payments will appear here after you submit them</small>
                        <br><br>
                        <button class="refresh-btn" onclick="forceRefreshHistory()">Refresh Payment History</button>
                    </td>
                </tr>
            `;
            return;
        }

        console.log('📊 DISPLAYING:', payments.length, 'payments');

        tbody.innerHTML = payments.map(payment => {
            const paymentId = payment.paymentId || payment.id || 'N/A';
            const policyInfo = payment.policy ?
                (payment.policy.policyNumber || `POL-${payment.policy.id}`) :
                'N/A';
            const month = payment.paymentMonth || 'N/A';
            const amount = payment.amount ? Number(payment.amount).toFixed(2) : '0.00';
            const method = payment.paymentMethod ? payment.paymentMethod.replace('_', ' ') : 'N/A';
            const status = payment.status || 'PENDING';
            const date = payment.submittedDate ? formatDate(payment.submittedDate) : 'N/A';

            const canEdit = canEditPayment(payment);
            const timeLeft = canEdit ? calculateTimeRemaining(payment.expiryTime) : 'Expired';

            console.log('📊 PAYMENT ROW:', {paymentId, month, amount, status, canEdit, timeLeft});

            return `
                <tr>
                    <td>${paymentId}</td>
                    <td>${policyInfo}</td>
                    <td>${month}</td>
                    <td>LKR ${amount}</td>
                    <td>${method}</td>
                    <td><span class="status-badge status-${status.toLowerCase()}">${status}</span></td>
                    <td>${date}</td>
                    <td>
                        ${status === 'PENDING' ?
                `<span id="timer-${paymentId}" class="${timeLeft === 'Expired' ? 'timer-danger' : 'timer-warning'}">
                                ${timeLeft}
                            </span>` :
                '<span style="color: #999; font-size: 11px;">N/A</span>'
            }
                    </td>
                    <td>
                        <button class="view-btn" onclick="viewPaymentDetails('${paymentId}')">
                            View
                        </button>
                        ${canEdit && status === 'PENDING' ? `
                            <div class="action-buttons">
                                <button class="edit-btn" onclick="editPayment('${paymentId}')"
                                        ${timeLeft === 'Expired' ? 'disabled' : ''}>
                                    Edit
                                </button>
                                <button class="delete-btn" onclick="deletePayment('${paymentId}')"
                                        ${timeLeft === 'Expired' ? 'disabled' : ''}>
                                    Delete
                                </button>
                            </div>
                        ` : ''}
                    </td>
                </tr>
            `;
        }).join('');

        // Start countdown timers for pending payments
        payments.forEach(payment => {
            if (payment.status === 'PENDING' && canEditPayment(payment)) {
                startTableCountdownTimer(payment.paymentId, payment.expiryTime);
            }
        });
    }

    // Start countdown timer in table
    function startTableCountdownTimer(paymentId, expiryTime) {
        const timerElement = document.getElementById(`timer-${paymentId}`);
        if (!timerElement) return;

        if (countdownTimers[paymentId]) {
            clearInterval(countdownTimers[paymentId]);
        }

        countdownTimers[paymentId] = setInterval(() => {
            const remaining = calculateTimeRemaining(expiryTime);
            timerElement.textContent = remaining;

            if (remaining === 'Expired') {
                clearInterval(countdownTimers[paymentId]);
                timerElement.textContent = 'Expired';
                timerElement.className = 'timer-danger';

                // Disable edit/delete buttons
                const editBtn = document.querySelector(`button[onclick="editPayment('${paymentId}')"]`);
                const deleteBtn = document.querySelector(`button[onclick="deletePayment('${paymentId}')"]`);
                if (editBtn) editBtn.disabled = true;
                if (deleteBtn) deleteBtn.disabled = true;
            }
        }, 1000);
    }

    // ENHANCED PAYMENT SUBMISSION WITH IMMEDIATE LOCAL UPDATE
    async function submitPayment() {
        if (!isBackendConnected) {
            showError('Backend connection required to submit payments.');
            return;
        }

        const submitBtn = document.getElementById('submitPaymentBtn');
        const activeTab = document.querySelector('.tab-content.active').id;

        const policyNumber = document.getElementById('policyNumber').value;
        const paymentMonth = document.getElementById('paymentMonth').value;
        const amount = document.getElementById('paymentAmount').value;

        if (!paymentMonth) {
            showError('Please select a payment month.');
            return;
        }

        if (!selectedPolicy) {
            showError('Policy information is missing. Please refresh and try again.');
            return;
        }

        const paymentData = {
            policy: {
                id: selectedPolicy.policyId
            },
            paymentMonth: paymentMonth,
            amount: parseFloat(amount)
        };

        if (activeTab === 'bankSlipTab') {
            const depositorName = document.getElementById('depositorName').value;
            const depositDate = document.getElementById('depositDate').value;
            const referenceNumber = document.getElementById('referenceNumber').value;

            if (!depositorName || !depositDate || !referenceNumber) {
                showError('Please fill in all bank slip details.');
                return;
            }

            paymentData.paymentMethod = 'BANK_SLIP';
            paymentData.bankSlipDetails = {
                bankName: bankDetails.bankName || 'Commercial Bank of Ceylon PLC',
                branch: bankDetails.branch || 'Colombo 03',
                depositDate: depositDate,
                referenceNumber: referenceNumber,
                depositorName: depositorName
            };
        } else if (activeTab === 'onlineTab') {
            const cardholderName = document.getElementById('cardholderName').value;
            const cardNumber = document.getElementById('cardNumber').value.replace(/\s/g, '');
            const expiryDate = document.getElementById('expiryDate').value;
            const cvc = document.getElementById('cvcCode').value;

            if (!cardholderName || !cardNumber || !expiryDate || !cvc) {
                showError('Please fill in all card details.');
                return;
            }

            if (cardNumber.length < 13 || cardNumber.length > 19) {
                showError('Please enter a valid card number.');
                return;
            }

            if (cvc.length < 3 || cvc.length > 4) {
                showError('Please enter a valid CVC code.');
                return;
            }

            paymentData.paymentMethod = 'ONLINE_PAYMENT';
            paymentData.onlinePaymentDetails = {
                cardholderName: cardholderName,
                cardNumber: cardNumber,
                expirationDate: expiryDate,
                cvc: cvc
            };
        }

        try {
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';

            console.log('💳 SUBMITTING PAYMENT:', paymentData);

            const response = await fetch(`${API_BASE_URL}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(paymentData)
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error('💳 SUBMISSION ERROR:', errorText);
                throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
            }

            const result = await response.json();
            console.log('💳 SUBMISSION SUCCESS:', result);

            // Upload bank slip if needed
            if (activeTab === 'bankSlipTab') {
                const fileInput = document.getElementById('bankSlipFile');
                if (fileInput.files[0]) {
                    await uploadBankSlip(result.paymentId, fileInput.files[0]);
                }
            }

            // Create local payment object to display immediately
            const localPayment = {
                paymentId: result.paymentId,
                policy: {
                    policyNumber: selectedPolicy.policyNumber,
                    id: selectedPolicy.policyId
                },
                paymentMonth: paymentMonth,
                amount: parseFloat(amount),
                paymentMethod: paymentData.paymentMethod,
                status: 'PENDING',
                submittedDate: new Date().toISOString(),
                expiryTime: new Date(Date.now() + 12 * 60 * 60 * 1000).toISOString(),
                bankSlipDetails: paymentData.bankSlipDetails,
                onlinePaymentDetails: paymentData.onlinePaymentDetails
            };

            // Add to current payments and refresh display immediately
            currentPayments.unshift(localPayment);

            showSuccess('🎉 Payment submitted successfully! You have 12 hours to edit or delete this payment if needed.');
            closeModal('paymentModal');

            // Immediately refresh the display with local data
            if (document.getElementById('historySection').style.display !== 'none') {
                displayPaymentHistory(currentPayments);
            }

            // Then refresh from server
            setTimeout(() => {
                loadPaymentHistory();
                loadUserPolicies();
            }, 2000);

            resetPaymentForm();

        } catch (error) {
            console.error('❌ Error submitting payment:', error);
            showError('Failed to submit payment: ' + error.message);
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Submit Payment';
        }
    }

    // Open payment modal
    function openPaymentModal(policy) {
        console.log('💳 Opening payment modal for policy:', policy);
        selectedPolicy = policy;

        document.getElementById('policyNumber').value = policy.policyNumber || policy.policyId;
        document.getElementById('paymentAmount').value = Number(policy.monthlyPremium).toFixed(2);

        const monthSelect = document.getElementById('paymentMonth');
        monthSelect.innerHTML = '<option value="">Select Month</option>';

        if (policy.pendingMonths && policy.pendingMonths.length > 0) {
            policy.pendingMonths.forEach(month => {
                monthSelect.innerHTML += `<option value="${month}">${month}</option>`;
            });
        }

        document.getElementById('paymentModal').classList.add('active');
    }

    // Switch between payment method tabs
    function switchTab(button, tabName) {
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        document.getElementById(tabName + 'Tab').classList.add('active');
    }

    // Switch between edit payment method tabs
    function switchEditTab(button, tabName) {
        document.querySelectorAll('#editPaymentModal .tab-button').forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        document.querySelectorAll('#editPaymentModal .tab-content').forEach(content => content.classList.remove('active'));
        document.getElementById('edit' + tabName.charAt(0).toUpperCase() + tabName.slice(1) + 'Tab').classList.add('active');
    }

    // Handle file upload
    function handleFileUpload(input) {
        const file = input.files[0];
        if (file) {
            if (!file.type.startsWith('image/')) {
                showError('Please select an image file.');
                input.value = '';
                return;
            }

            if (file.size > 5 * 1024 * 1024) {
                showError('File size must be less than 5MB.');
                input.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('previewImage').src = e.target.result;
                document.getElementById('filePreview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
    }

    // Upload bank slip
    async function uploadBankSlip(paymentId, file) {
        const formData = new FormData();
        formData.append('file', file);

        try {
            const response = await fetch(`${API_BASE_URL}/${paymentId}/upload-slip`, {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                throw new Error('Failed to upload bank slip');
            }

            console.log('✅ Bank slip uploaded successfully');

        } catch (error) {
            console.error('❌ Error uploading bank slip:', error);
            showError('Payment submitted but failed to upload bank slip. You can upload it later by editing the payment.');
        }
    }

    // FIXED - Edit payment with proper error handling
    async function editPayment(paymentId) {
        if (!isBackendConnected) {
            showError('Backend connection required for edit functionality.');
            return;
        }

        console.log('✏️ EDITING PAYMENT:', paymentId);

        try {
            const response = await fetch(`${API_BASE_URL}/${paymentId}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                }
            });

            console.log('✏️ EDIT RESPONSE STATUS:', response.status);

            if (!response.ok) {
                const errorText = await response.text();
                console.error('✏️ EDIT ERROR:', errorText);
                throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
            }

            const responseText = await response.text();
            console.log('✏️ EDIT RAW RESPONSE:', responseText);

            let payment;
            try {
                payment = JSON.parse(responseText);
                console.log('✏️ EDIT PARSED PAYMENT:', payment);
            } catch (parseError) {
                console.error('✏️ EDIT PARSE ERROR:', parseError);
                throw new Error('Invalid response format from server');
            }

            // Check if payment can still be edited
            if (!canEditPayment(payment)) {
                showError('Payment cannot be edited. The 12-hour window has expired or payment is not pending.');
                return;
            }

            openEditPaymentModal(payment);

        } catch (error) {
            console.error('❌ Error loading payment for edit:', error);
            showError(`Failed to load payment details for editing: ${error.message}`);
        }
    }

    // Open edit payment modal with populated data
    function openEditPaymentModal(payment) {
        selectedPayment = payment;

        console.log('✏️ OPENING EDIT MODAL FOR:', payment);

        // Populate form fields
        document.getElementById('editPaymentId').value = payment.paymentId || payment.id;
        document.getElementById('editPolicyNumber').value = payment.policy ? (payment.policy.policyNumber || `POL-${payment.policy.id}`) : 'N/A';
        document.getElementById('editPaymentMonth').value = payment.paymentMonth || '';
        document.getElementById('editPaymentAmount').value = payment.amount || '';

        // Set payment method tab and details
        if (payment.paymentMethod === 'BANK_SLIP' && payment.bankSlipDetails) {
            // Activate bank slip tab
            document.querySelectorAll('#editPaymentModal .tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('#editPaymentModal .tab-content').forEach(content => content.classList.remove('active'));
            document.querySelector('#editPaymentModal .tab-button').classList.add('active');
            document.getElementById('editBankSlipTab').classList.add('active');

            // Populate bank slip details
            document.getElementById('editDepositorName').value = payment.bankSlipDetails.depositorName || '';
            document.getElementById('editDepositDate').value = payment.bankSlipDetails.depositDate || '';
            document.getElementById('editReferenceNumber').value = payment.bankSlipDetails.referenceNumber || '';
        } else if (payment.paymentMethod === 'ONLINE_PAYMENT' && payment.onlinePaymentDetails) {
            // Activate online payment tab
            document.querySelectorAll('#editPaymentModal .tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('#editPaymentModal .tab-content').forEach(content => content.classList.remove('active'));
            document.querySelectorAll('#editPaymentModal .tab-button')[1].classList.add('active');
            document.getElementById('editOnlineTab').classList.add('active');

            // Populate online payment details
            document.getElementById('editCardholderName').value = payment.onlinePaymentDetails.cardholderName || '';
            document.getElementById('editCardNumber').value = payment.onlinePaymentDetails.cardNumber || '';
            document.getElementById('editExpiryDate').value = payment.onlinePaymentDetails.expirationDate || '';
            document.getElementById('editCvcCode').value = payment.onlinePaymentDetails.cvc || '';
        }

        // Start countdown timer
        if (payment.expiryTime) {
            startEditCountdownTimer(payment.expiryTime);
        }

        document.getElementById('editPaymentModal').classList.add('active');
    }

    // Start countdown timer in edit modal
    function startEditCountdownTimer(expiryTime) {
        const countdownElement = document.getElementById('editCountdownDisplay');
        const timerContainer = document.getElementById('editCountdownTimer');

        if (!countdownElement) return;

        // Clear existing timer
        if (countdownTimers['edit']) {
            clearInterval(countdownTimers['edit']);
        }

        countdownTimers['edit'] = setInterval(() => {
            const remaining = calculateTimeRemaining(expiryTime);
            countdownElement.textContent = remaining;

            if (remaining === 'Expired') {
                clearInterval(countdownTimers['edit']);
                countdownElement.textContent = 'Expired - Cannot Edit';
                timerContainer.classList.add('countdown-expired');

                // Disable update button
                const updateBtn = document.getElementById('updatePaymentBtn');
                if (updateBtn) {
                    updateBtn.disabled = true;
                    updateBtn.textContent = 'Time Expired';
                }
            }
        }, 1000);
    }

    // Update payment
    async function updatePayment() {
        const updateBtn = document.getElementById('updatePaymentBtn');

        if (!selectedPayment) {
            showError('No payment selected for update.');
            return;
        }

        if (!canEditPayment(selectedPayment)) {
            showError('Payment cannot be updated. The 12-hour window has expired.');
            return;
        }

        const activeTab = document.querySelector('#editPaymentModal .tab-content.active').id;

        const paymentMonth = document.getElementById('editPaymentMonth').value;
        const amount = document.getElementById('editPaymentAmount').value;

        if (!paymentMonth) {
            showError('Please select a payment month.');
            return;
        }

        if (!amount || amount <= 0) {
            showError('Please enter a valid amount.');
            return;
        }

        const updatedPaymentData = {
            paymentMonth: paymentMonth,
            amount: parseFloat(amount)
        };

        if (activeTab === 'editBankSlipTab') {
            const depositorName = document.getElementById('editDepositorName').value;
            const depositDate = document.getElementById('editDepositDate').value;
            const referenceNumber = document.getElementById('editReferenceNumber').value;

            if (!depositorName || !depositDate || !referenceNumber) {
                showError('Please fill in all bank slip details.');
                return;
            }

            updatedPaymentData.bankSlipDetails = {
                bankName: bankDetails.bankName || 'Commercial Bank of Ceylon PLC',
                branch: bankDetails.branch || 'Colombo 03',
                depositDate: depositDate,
                referenceNumber: referenceNumber,
                depositorName: depositorName
            };
        } else if (activeTab === 'editOnlineTab') {
            const cardholderName = document.getElementById('editCardholderName').value;
            const cardNumber = document.getElementById('editCardNumber').value.replace(/\s/g, '');
            const expiryDate = document.getElementById('editExpiryDate').value;
            const cvc = document.getElementById('editCvcCode').value;

            if (!cardholderName || !cardNumber || !expiryDate || !cvc) {
                showError('Please fill in all card details.');
                return;
            }

            if (cardNumber.length < 13 || cardNumber.length > 19) {
                showError('Please enter a valid card number.');
                return;
            }

            if (cvc.length < 3 || cvc.length > 4) {
                showError('Please enter a valid CVC code.');
                return;
            }

            updatedPaymentData.onlinePaymentDetails = {
                cardholderName: cardholderName,
                cardNumber: cardNumber,
                expirationDate: expiryDate,
                cvc: cvc
            };
        }

        try {
            updateBtn.disabled = true;
            updateBtn.textContent = 'Updating...';

            const paymentId = selectedPayment.paymentId || selectedPayment.id;
            console.log('💫 UPDATING PAYMENT:', paymentId, updatedPaymentData);

            const response = await fetch(`${API_BASE_URL}/${paymentId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(updatedPaymentData)
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error('💫 UPDATE ERROR:', errorText);
                throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
            }

            const result = await response.json();
            console.log('💫 UPDATE SUCCESS:', result);

            showSuccess('✅ Payment updated successfully!');
            closeModal('editPaymentModal');

            // Refresh with staggered delays
            setTimeout(() => loadPaymentHistory(), 500);
            setTimeout(() => loadUserPolicies(), 1000);

        } catch (error) {
            console.error('❌ Error updating payment:', error);
            showError('Failed to update payment: ' + error.message);
        } finally {
            updateBtn.disabled = false;
            updateBtn.textContent = 'Update Payment';
        }
    }

    // Delete payment
    async function deletePayment(paymentId) {
        if (!isBackendConnected) {
            showError('Backend connection required for delete functionality.');
            return;
        }

        if (!confirm('Are you sure you want to delete this payment? This action cannot be undone.')) {
            return;
        }

        try {
            console.log('🗑️ DELETING PAYMENT:', paymentId);

            const response = await fetch(`${API_BASE_URL}/${paymentId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error('🗑️ DELETE ERROR:', errorText);
                throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
            }

            console.log('🗑️ DELETE SUCCESS');

            // Remove from local payments array immediately
            currentPayments = currentPayments.filter(p => (p.paymentId || p.id) != paymentId);

            showSuccess('✅ Payment deleted successfully.');

            // Refresh display immediately with local data
            if (document.getElementById('historySection').style.display !== 'none') {
                displayPaymentHistory(currentPayments);
            }

            // Then refresh from server
            setTimeout(() => {
                loadPaymentHistory();
                loadUserPolicies();
            }, 1000);

        } catch (error) {
            console.error('❌ Error deleting payment:', error);
            showError('Failed to delete payment: ' + error.message);
        }
    }

    // FIXED - View payment details with proper error handling
    async function viewPaymentDetails(paymentId) {
        if (!isBackendConnected) {
            showError('Backend connection required for view details functionality.');
            return;
        }

        console.log('👁️ VIEWING PAYMENT DETAILS:', paymentId);

        try {
            const response = await fetch(`${API_BASE_URL}/${paymentId}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                }
            });

            console.log('👁️ VIEW RESPONSE STATUS:', response.status);

            if (!response.ok) {
                const errorText = await response.text();
                console.error('👁️ VIEW ERROR:', errorText);
                throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
            }

            const responseText = await response.text();
            console.log('👁️ VIEW RAW RESPONSE:', responseText);

            let payment;
            try {
                payment = JSON.parse(responseText);
                console.log('👁️ VIEW PARSED PAYMENT:', payment);
            } catch (parseError) {
                console.error('👁️ VIEW PARSE ERROR:', parseError);
                throw new Error('Invalid response format from server');
            }

            showPaymentDetailsModal(payment);

        } catch (error) {
            console.error('❌ Error loading payment details:', error);
            showError(`Failed to load payment details: ${error.message}`);
        }
    }

    // Show payment details modal
    function showPaymentDetailsModal(payment) {
        const modal = document.getElementById('paymentDetailsModal');
        const body = document.getElementById('paymentDetailsBody');

        const timeRemaining = canEditPayment(payment) ? calculateTimeRemaining(payment.expiryTime) : null;

        body.innerHTML = `
            ${timeRemaining && timeRemaining !== 'Expired' && payment.status === 'PENDING' ? `
                <div class="countdown-timer">
                    <div class="countdown-text">Time remaining to edit/delete</div>
                    <div class="countdown-time" id="detailsCountdownDisplay">${timeRemaining}</div>
                </div>
            ` : ''}

            <div class="form-group">
                <label class="form-label">Payment ID</label>
                <div>${payment.paymentId || payment.id}</div>
            </div>

            <div class="form-group">
                <label class="form-label">Policy Number</label>
                <div>${payment.policy ? (payment.policy.policyNumber || 'POL-' + payment.policy.id) : 'N/A'}</div>
            </div>

            <div class="form-group">
                <label class="form-label">Payment Month</label>
                <div>${payment.paymentMonth}</div>
            </div>

            <div class="form-group">
                <label class="form-label">Amount</label>
                <div>LKR ${Number(payment.amount).toFixed(2)}</div>
            </div>

            <div class="form-group">
                <label class="form-label">Payment Method</label>
                <div>${payment.paymentMethod ? payment.paymentMethod.replace('_', ' ') : 'N/A'}</div>
            </div>

            <div class="form-group">
                <label class="form-label">Status</label>
                <div><span class="status-badge status-${payment.status.toLowerCase()}">${payment.status}</span></div>
            </div>

            <div class="form-group">
                <label class="form-label">Submitted Date</label>
                <div>${formatDateTime(payment.submittedDate)}</div>
            </div>

            ${payment.approvedDate ? `
                <div class="form-group">
                    <label class="form-label">Approved Date</label>
                    <div>${formatDateTime(payment.approvedDate)}</div>
                </div>
            ` : ''}

            ${payment.adminComments ? `
                <div class="form-group">
                    <label class="form-label">Admin Comments</label>
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 6px;">${payment.adminComments}</div>
                </div>
            ` : ''}

            ${payment.bankSlipDetails ? `
                <div class="form-group">
                    <label class="form-label">Bank Slip Details</label>
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 6px;">
                        <p><strong>Bank:</strong> ${payment.bankSlipDetails.bankName || 'N/A'}</p>
                        <p><strong>Branch:</strong> ${payment.bankSlipDetails.branch || 'N/A'}</p>
                        <p><strong>Depositor:</strong> ${payment.bankSlipDetails.depositorName || 'N/A'}</p>
                        <p><strong>Reference:</strong> ${payment.bankSlipDetails.referenceNumber || 'N/A'}</p>
                        <p><strong>Date:</strong> ${payment.bankSlipDetails.depositDate || 'N/A'}</p>
                    </div>
                </div>
            ` : ''}

            ${payment.onlinePaymentDetails ? `
                <div class="form-group">
                    <label class="form-label">Online Payment Details</label>
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 6px;">
                        <p><strong>Cardholder:</strong> ${payment.onlinePaymentDetails.cardholderName || 'N/A'}</p>
                        <p><strong>Card Number:</strong> **** **** **** ${payment.onlinePaymentDetails.cardNumber ? payment.onlinePaymentDetails.cardNumber.slice(-4) : 'N/A'}</p>
                        <p><strong>Transaction ID:</strong> ${payment.onlinePaymentDetails.transactionId || 'Pending'}</p>
                    </div>
                </div>
            ` : ''}

            ${canEditPayment(payment) && payment.status === 'PENDING' ? `
                <div class="action-buttons">
                    <button class="edit-btn" onclick="closeModal('paymentDetailsModal'); editPayment('${payment.paymentId || payment.id}')"
                            ${timeRemaining === 'Expired' ? 'disabled' : ''}>
                        Edit Payment
                    </button>
                    <button class="delete-btn" onclick="closeModal('paymentDetailsModal'); deletePayment('${payment.paymentId || payment.id}')"
                            ${timeRemaining === 'Expired' ? 'disabled' : ''}>
                        Delete Payment
                    </button>
                </div>
            ` : ''}
        `;

        modal.classList.add('active');

        // Start countdown timer if payment can be edited
        if (timeRemaining && timeRemaining !== 'Expired' && payment.status === 'PENDING') {
            startDetailsCountdownTimer(payment.expiryTime);
        }
    }

    // Start countdown timer in details modal
    function startDetailsCountdownTimer(expiryTime) {
        const countdownElement = document.getElementById('detailsCountdownDisplay');
        if (!countdownElement) return;

        // Clear existing timer
        if (countdownTimers['details']) {
            clearInterval(countdownTimers['details']);
        }

        countdownTimers['details'] = setInterval(() => {
            const remaining = calculateTimeRemaining(expiryTime);
            countdownElement.textContent = remaining;

            if (remaining === 'Expired') {
                clearInterval(countdownTimers['details']);
                countdownElement.textContent = 'Expired';
                countdownElement.parentElement.classList.add('countdown-expired');

                // Disable action buttons
                const editBtn = document.querySelector('#paymentDetailsModal .edit-btn');
                const deleteBtn = document.querySelector('#paymentDetailsModal .delete-btn');
                if (editBtn) editBtn.disabled = true;
                if (deleteBtn) deleteBtn.disabled = true;
            }
        }, 1000);
    }

    // Set active tab
    function setActiveTab(element, tab) {
        document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
        element.classList.add('active');

        if (tab === 'policies') {
            document.getElementById('policiesSection').style.display = 'block';
            document.getElementById('historySection').style.display = 'none';
            if (isBackendConnected && currentPolicies.length === 0) {
                loadUserPolicies();
            }
        } else if (tab === 'history' || tab === 'pending') {
            document.getElementById('policiesSection').style.display = 'none';
            document.getElementById('historySection').style.display = 'block';
            // Always reload payment history when switching to this tab
            refreshAttempts = 0; // Reset refresh attempts
            loadPaymentHistory();
        }
    }

    // COMPLETE UTILITY FUNCTIONS
    function updateBankDetailsUI() {
        if (bankDetails.bankName) {
            document.getElementById('bankName').textContent = bankDetails.bankName;
            document.getElementById('accountNumber').textContent = bankDetails.accountNumber;
            document.getElementById('accountName').textContent = bankDetails.accountName;
            document.getElementById('branchName').textContent = bankDetails.branch;
        }
    }

    function canEditPayment(payment) {
        if (!payment || !payment.status) return false;

        const isPending = payment.status === 'PENDING' || payment.status === 'pending';

        if (!isPending) return false;

        // If no expiry time, assume it can be edited (newly created)
        if (!payment.expiryTime) return true;

        try {
            const now = new Date();
            const expiry = new Date(payment.expiryTime);
            return now < expiry;
        } catch (e) {
            console.error('Error checking expiry time:', e);
            return true; // Default to editable if date parsing fails
        }
    }

    function calculateTimeRemaining(expiryTime) {
        if (!expiryTime) return '12:00:00'; // Default for new payments

        try {
            const now = new Date();
            const expiry = new Date(expiryTime);
            const diff = expiry - now;

            if (diff <= 0) return 'Expired';

            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);

            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        } catch (e) {
            console.error('Error calculating time remaining:', e);
            return '12:00:00';
        }
    }

    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        try {
            return new Date(dateString).toLocaleDateString();
        } catch (e) {
            return 'N/A';
        }
    }

    function formatDateTime(dateString) {
        if (!dateString) return 'N/A';
        try {
            return new Date(dateString).toLocaleString();
        } catch (e) {
            return 'N/A';
        }
    }

    function resetPaymentForm() {
        document.getElementById('paymentMonth').value = '';
        document.getElementById('depositorName').value = '';
        document.getElementById('depositDate').value = '';
        document.getElementById('referenceNumber').value = '';
        document.getElementById('bankSlipFile').value = '';
        document.getElementById('filePreview').style.display = 'none';
        document.getElementById('cardholderName').value = '';
        document.getElementById('cardNumber').value = '';
        document.getElementById('expiryDate').value = '';
        document.getElementById('cvcCode').value = '';

        // Reset tabs to bank slip
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        document.querySelector('.tab-button').classList.add('active');
        document.getElementById('bankSlipTab').classList.add('active');
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('active');

        // Clear timers when closing modals
        if (modalId === 'editPaymentModal' && countdownTimers['edit']) {
            clearInterval(countdownTimers['edit']);
            delete countdownTimers['edit'];
        }
        if (modalId === 'paymentDetailsModal' && countdownTimers['details']) {
            clearInterval(countdownTimers['details']);
            delete countdownTimers['details'];
        }

        if (modalId === 'paymentModal') {
            resetPaymentForm();
        }
    }

    function showError(message) {
        console.error('❌ Error:', message);
        const existingError = document.querySelector('.error');
        if (existingError) existingError.remove();

        const errorDiv = document.createElement('div');
        errorDiv.className = 'error';
        errorDiv.textContent = message;
        document.querySelector('.main-content').prepend(errorDiv);

        setTimeout(() => {
            if (errorDiv.parentNode) {
                errorDiv.remove();
            }
        }, 8000);
    }

    function showSuccess(message) {
        console.log('✅ Success:', message);
        const existingSuccess = document.querySelector('.success');
        if (existingSuccess) existingSuccess.remove();

        const successDiv = document.createElement('div');
        successDiv.className = 'success';
        successDiv.textContent = message;
        document.querySelector('.main-content').prepend(successDiv);

        setTimeout(() => {
            if (successDiv.parentNode) {
                successDiv.remove();
            }
        }, 5000);
    }

    function setupEventListeners() {
        // Card number formatting for both modals
        ['cardNumber', 'editCardNumber'].forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\s/g, '').replace(/\D/g, '');
                    value = value.replace(/(\d{4})/g, '$1 ').trim();
                    if (value.length > 23) value = value.substring(0, 23);
                    e.target.value = value;
                });
            }
        });

        // Expiry date formatting for both modals
        ['expiryDate', 'editExpiryDate'].forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length >= 2) {
                        value = value.substring(0, 2) + '/' + value.substring(2, 4);
                    }
                    e.target.value = value;
                });
            }
        });

        // CVC code - only numbers for both modals
        ['cvcCode', 'editCvcCode'].forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('input', function(e) {
                    e.target.value = e.target.value.replace(/\D/g, '');
                });
            }
        });

        // File drag and drop
        const fileUpload = document.querySelector('.file-upload');
        if (fileUpload) {
            fileUpload.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('dragover');
            });

            fileUpload.addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
            });

            fileUpload.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');

                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const fileInput = document.getElementById('bankSlipFile');
                    fileInput.files = files;
                    handleFileUpload(fileInput);
                }
            });
        }

        // Close modals on outside click
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                closeModal(e.target.id);
            }
        });

        // ESC key to close modals
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const activeModal = document.querySelector('.modal.active');
                if (activeModal) {
                    closeModal(activeModal.id);
                }
            }
        });

        // Connection status click to retry
        document.addEventListener('click', function(e) {
            if (e.target.id === 'connectionStatus' && !isBackendConnected) {
                console.log('🔄 Retrying backend connection...');
                checkBackendConnection();
            }
        });
    }

    // Cleanup timers when page unloads
    window.addEventListener('beforeunload', function() {
        Object.values(countdownTimers).forEach(timer => clearInterval(timer));
    });
</script>
</body>
</html>
